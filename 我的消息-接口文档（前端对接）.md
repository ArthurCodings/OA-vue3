# 我的消息 - 接口文档（前端对接）

> 基于若依 RuoYi-Vue-Pro 管理后台，IM 模块所有接口说明。  
> 后端已配置 **Knife4j + SpringDoc**，启动后可访问：`http://{后端地址}/doc.html` 查看并调试接口。

---

## 一、通用说明

### 1.1 请求基础地址

| 环境 | 说明 |
|------|------|
| 开发 | `http://localhost:48080/admin-api`（端口以 `application-local.yaml` 为准） |
| 生产 | `https://{域名}/admin-api` |

**所有 IM 接口路径均以 `/admin-api/system/im/` 为前缀。**

### 1.2 统一响应格式

所有接口均返回 `CommonResult<T>` 包装：

```json
{
  "code": 0,
  "msg": "操作成功",
  "data": { ... }
}
```

- `code`：0 表示成功，非 0 为业务/系统错误码  
- `msg`：提示信息  
- `data`：业务数据，类型见各接口说明  

### 1.3 认证方式

管理后台接口需登录态，请求头携带：

- `Authorization: Bearer {token}`  
或项目约定的 Cookie/Header 方式（与现有登录接口一致）。

### 1.4 分页参数（Query）

使用 `PageParam` 的接口支持：

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| pageNo | number | 是 | 页码，从 1 开始，默认 1 |
| pageSize | number | 是 | 每页条数，1~200，默认 10 |

### 1.5 权限标识（供角色/菜单配置）

| 标识 | 说明 |
|------|------|
| system:im:query | 查看会话列表、消息列表、成员列表、已读状态、标记已读、修改群名、解散群 |
| system:im:create | 创建单聊 |
| system:im:create-group | 创建群聊 |
| system:im:send | 发送消息、撤回消息 |
| system:im:manage-member | 邀请成员、踢出成员 |

---

## 二、会话接口（Conversation）

**Base Path：** `/admin-api/system/im/conversation`

---

### 2.1 获取我的会话列表（含未读数）

**GET** `/list`

**说明：** 当前登录用户参与的会话列表，按置顶、最后消息时间排序；单聊展示对方昵称/头像，群聊展示群名/群头像；含未读数。

**权限：** `system:im:query`

**请求参数：** 无（当前用户从 token 解析）

**响应 data：** `ConversationListRespVO[]`

| 字段 | 类型 | 说明 |
|------|------|------|
| id | number | 会话ID |
| type | number | 1=单聊 2=群聊 |
| name | string | 会话名称（单聊=对方昵称，群聊=群名） |
| avatar | string | 会话头像（单聊=对方头像，群聊=群头像） |
| ownerId | number | 群主ID（单聊为 0） |
| notice | string | 群公告 |
| lastMessageContent | string | 最后一条消息摘要 |
| lastMessageTime | string | 最后一条消息时间，ISO 格式 |
| unreadCount | number | 未读消息数 |
| otherUserId | number | 单聊时对方用户ID，群聊无或 0 |
| isPinned | boolean | 是否置顶 |
| isDisturb | boolean | 是否免打扰 |
| createTime | string | 创建时间，ISO 格式 |

**示例：**

```http
GET /admin-api/system/im/conversation/list
```

---

### 2.2 创建或获取单聊会话

**POST** `/create-single`

**说明：** 与指定用户单聊。若已存在两人单聊会话则返回该会话ID，否则新建并返回新会话ID。

**权限：** `system:im:create`

**请求体：** `ConversationCreateSingleReqVO`（application/json）

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| targetUserId | number | 是 | 对方用户ID |

**响应 data：** `number`（会话ID）

**示例：**

```json
// Request
POST /admin-api/system/im/conversation/create-single
Content-Type: application/json
{ "targetUserId": 100 }

// Response data
1
```

---

### 2.3 创建群聊会话

**POST** `/create-group`

**说明：** 创建群聊，当前用户为群主；可带初始成员（不含自己），自己会自动加入。

**权限：** `system:im:create-group`

**请求体：** `ConversationCreateGroupReqVO`（application/json）

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| name | string | 是 | 群名称 |
| avatar | string | 否 | 群头像 URL |
| memberUserIds | number[] | 是 | 初始成员用户ID列表（不含创建者） |

**响应 data：** `number`（会话ID）

**示例：**

```json
// Request
POST /admin-api/system/im/conversation/create-group
{ "name": "研发一组", "avatar": "https://...", "memberUserIds": [2, 3, 4] }

// Response data
2
```

---

### 2.4 修改群聊名称

**PUT** `/update-name`

**说明：** 仅群聊有效，需有权限（如群主/管理员，由后端校验）。

**权限：** `system:im:query`

**请求体：** `ConversationUpdateNameReqVO`（application/json）

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | number | 是 | 会话ID |
| name | string | 是 | 新群名称 |

**响应 data：** `true`

---

### 2.5 解散群聊

**DELETE** `/dismiss/{id}`

**说明：** 解散群聊，仅群主可操作（后端校验）。

**权限：** `system:im:query`

**路径参数：**

| 参数 | 类型 | 说明 |
|------|------|------|
| id | number | 会话ID |

**响应 data：** `true`

**示例：**

```http
DELETE /admin-api/system/im/conversation/dismiss/2
```

---

## 三、会话成员接口（ConversationMember）

**Base Path：** `/admin-api/system/im/conversation-member`

---

### 3.1 查询群聊成员列表

**GET** `/list/{conversationId}`

**说明：** 当前用户必须是该会话成员，单聊/群聊均可调（群聊展示角色、昵称、头像等）。

**权限：** `system:im:query`

**路径参数：**

| 参数 | 类型 | 说明 |
|------|------|------|
| conversationId | number | 会话ID |

**响应 data：** `ConversationMemberListRespVO[]`

| 字段 | 类型 | 说明 |
|------|------|------|
| id | number | 成员记录ID |
| userId | number | 用户ID |
| nickname | string | 昵称 |
| avatar | string | 头像 |
| memberRole | number | 0=普通成员 1=群主 2=群管理员 |
| isMuted | boolean | 是否被禁言 |
| joinTime | string | 加入时间，ISO 格式 |

**示例：**

```http
GET /admin-api/system/im/conversation-member/list/2
```

---

### 3.2 邀请成员加入群聊

**POST** `/invite`

**说明：** 仅群主/群管理员可操作；已在该群用户会忽略。

**权限：** `system:im:manage-member`

**请求体：** `ConversationMemberInviteReqVO`（application/json）

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| conversationId | number | 是 | 会话ID |
| userIds | number[] | 是 | 被邀请用户ID列表 |

**响应 data：** `true`

---

### 3.3 踢出群聊成员

**DELETE** `/remove`

**说明：** 仅群主/群管理员可操作。

**权限：** `system:im:manage-member`

**请求体：** `ConversationMemberRemoveReqVO`（application/json）

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| conversationId | number | 是 | 会话ID |
| userId | number | 是 | 被踢用户ID |

**响应 data：** `true`

---

### 3.4 标记会话消息全部已读

**PUT** `/read/{conversationId}`

**说明：** 进入会话后调用，将该会话下当前用户的“最后已读消息ID”更新为最新消息，未读数清零。

**权限：** `system:im:query`

**路径参数：**

| 参数 | 类型 | 说明 |
|------|------|------|
| conversationId | number | 会话ID |

**响应 data：** `true`

**示例：**

```http
PUT /admin-api/system/im/conversation-member/read/1
```

---

## 四、消息接口（Message）

**Base Path：** `/admin-api/system/im/message`

---

### 4.1 分页查询会话消息列表

**GET** `/list/{conversationId}`

**说明：** 按会话分页查消息，**按消息ID倒序**（最新消息在前）；当前用户须为该会话成员。

**权限：** `system:im:query`

**路径参数：**

| 参数 | 类型 | 说明 |
|------|------|------|
| conversationId | number | 会话ID |

**Query 参数（分页）：** 见 1.4，`pageNo`、`pageSize`

**响应 data：** `PageResult<MessageRespVO>`

| 字段 | 类型 | 说明 |
|------|------|------|
| total | number | 总条数 |
| list | MessageRespVO[] | 当前页数据 |

**MessageRespVO：**

| 字段 | 类型 | 说明 |
|------|------|------|
| id | number | 消息ID |
| conversationId | number | 会话ID |
| senderId | number | 发送人用户ID |
| contentType | number | 1=文本 2=图片 3=文件 4=系统消息 |
| content | string | 消息内容（文本原文；图片/文件为 URL） |
| fileName | string | 文件原始名称（type=3 时有效） |
| fileSize | number | 文件大小字节（type=3 时有效） |
| status | number | 0=正常 1=已撤回 |
| createTime | string | 创建时间，ISO 格式 |
| senderNickname | string | 发送者昵称 |
| senderAvatar | string | 发送者头像 |

**示例：**

```http
GET /admin-api/system/im/message/list/1?pageNo=1&pageSize=20
```

---

### 4.2 发送消息

**POST** `/send`

**说明：** 当前用户须为该会话成员；发送成功后服务端会更新会话最后一条消息摘要，并可选推送 WebSocket。

**权限：** `system:im:send`

**请求体：** `MessageSendReqVO`（application/json）

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| conversationId | number | 是 | 会话ID |
| contentType | number | 是 | 1=文本 2=图片 3=文件 4=系统消息 |
| content | string | 是 | 消息内容（文本原文；图片/文件为 URL） |
| fileName | string | 否 | 文件原始名称（contentType=3 时建议传） |
| fileSize | number | 否 | 文件大小字节（contentType=3 时建议传） |

**响应 data：** `number`（新消息ID）

**示例：**

```json
// 文本
POST /admin-api/system/im/message/send
{ "conversationId": 1, "contentType": 1, "content": "你好" }

// 文件（先调上传接口拿 URL，再发消息）
{ "conversationId": 1, "contentType": 3, "content": "https://xxx/file.pdf", "fileName": "合同.pdf", "fileSize": 102400 }
```

---

### 4.3 撤回消息

**PUT** `/recall/{id}`

**说明：** 仅发送者本人可撤回；撤回后 status 变为 1（已撤回），前端可按 status 展示“已撤回”。

**权限：** `system:im:send`

**路径参数：**

| 参数 | 类型 | 说明 |
|------|------|------|
| id | number | 消息ID |

**响应 data：** `true`

**示例：**

```http
PUT /admin-api/system/im/message/recall/100
```

---

### 4.4 群聊消息已读/未读详情（发送者专用）

**GET** `/read-status/{messageId}`

**说明：** 仅该消息的发送者可调用；返回该条消息的已读人数、未读人数及已读/未读用户列表（用于“2/4 已读”“谁已读”“谁未读”展示）。

**权限：** `system:im:query`

**路径参数：**

| 参数 | 类型 | 说明 |
|------|------|------|
| messageId | number | 消息ID |

**响应 data：** `MessageReadStatusRespVO`

| 字段 | 类型 | 说明 |
|------|------|------|
| readCount | number | 已读人数 |
| unreadCount | number | 未读人数 |
| totalCount | number | 总成员数（不含发送者） |
| readUserList | UserSimpleVO[] | 已读用户列表 |
| unreadUserList | UserSimpleVO[] | 未读用户列表 |

**UserSimpleVO：**

| 字段 | 类型 | 说明 |
|------|------|------|
| userId | number | 用户ID |
| nickname | string | 昵称 |
| avatar | string | 头像 |

**示例：**

```http
GET /admin-api/system/im/message/read-status/100
```

---

## 五、接口速查表

| 模块 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 会话 | GET | `/system/im/conversation/list` | 我的会话列表（含未读数） |
| 会话 | POST | `/system/im/conversation/create-single` | 创建/获取单聊 |
| 会话 | POST | `/system/im/conversation/create-group` | 创建群聊 |
| 会话 | PUT | `/system/im/conversation/update-name` | 修改群名 |
| 会话 | DELETE | `/system/im/conversation/dismiss/{id}` | 解散群聊 |
| 成员 | GET | `/system/im/conversation-member/list/{conversationId}` | 成员列表 |
| 成员 | POST | `/system/im/conversation-member/invite` | 邀请成员 |
| 成员 | DELETE | `/system/im/conversation-member/remove` | 踢出成员 |
| 成员 | PUT | `/system/im/conversation-member/read/{conversationId}` | 标记已读 |
| 消息 | GET | `/system/im/message/list/{conversationId}` | 分页消息列表 |
| 消息 | POST | `/system/im/message/send` | 发送消息 |
| 消息 | PUT | `/system/im/message/recall/{id}` | 撤回消息 |
| 消息 | GET | `/system/im/message/read-status/{messageId}` | 已读/未读详情 |

**完整 URL = 基础地址 + `/admin-api` + 上表路径**  
例如：`GET http://localhost:48080/admin-api/system/im/conversation/list`

---

## 六、错误码说明

- `code = 0`：成功  
- 非 0：见后端统一错误码或 `msg` 提示；IM 相关如会话不存在、非会话成员、无权限等会返回对应业务错误码与提示。

---

## 七、前端对接建议

1. **会话列表**：进入「我的消息」页先调 `GET /conversation/list`，用 `unreadCount` 展示红点/数字。  
2. **选会话**：点某个会话后调 `PUT /conversation-member/read/{conversationId}` 标记已读，再调 `GET /message/list/{conversationId}` 拉消息（可配合分页上拉加载更多）。  
3. **发消息**：先调上传接口拿到文件/图片 URL，再 `POST /message/send`，contentType 对应 1/2/3。  
4. **群聊已读**：仅发送者展示“2/4 已读”；点击时调 `GET /message/read-status/{messageId}`，切换展示 readUserList / unreadUserList。  
5. **单聊**：创建会话统一用 `POST /conversation/create-single`，后端保证同一两人只有一个单聊会话。

若依项目已启用 Knife4j，可直接在 `http://{后端地址}/doc.html` 中查看上述接口的请求/响应结构并联调。
