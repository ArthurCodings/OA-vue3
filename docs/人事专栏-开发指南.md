# 人事专栏 & 基础设施扩展 — 完整开发指南

> 基于若依 RuoYi-Vue-Pro，混合方案（代码生成骨架 + 手工改造）。  
> 涵盖：人事专栏（考勤 / 薪资结算 / 花名册）、基础设施扩展（在线文档 / 合同管理）、个人中心聚合面板。

---

## 一、整体架构说明

### 1.1 菜单结构规划

```
首页
人事专栏（新增一级目录）
  ├── 考勤
  ├── 薪资结算
  └── 花名册
基础设施（已有，扩展子菜单）
  ├── 在线文档（新增）
  ├── 合同管理（新增）
  └── ...原有子菜单
个人中心（已有，扩展工作台面板）
```

### 1.2 后端模块放置规则

| 功能 | 后端模块 | Java 包路径 |
|------|----------|-------------|
| 考勤（4张表） | `yudao-module-system` | `cn.iocoder.yudao.module.system.controller.admin.hr.attendance` |
| 薪资结算（3张表） | `yudao-module-system` | `cn.iocoder.yudao.module.system.controller.admin.hr.salary` |
| 花名册（1张表） | `yudao-module-system` | `cn.iocoder.yudao.module.system.controller.admin.hr.employee` |
| 在线文档（2张表） | `yudao-module-infra` | `cn.iocoder.yudao.module.infra.controller.admin.doc` |
| 合同管理（1张表） | `yudao-module-infra` | `cn.iocoder.yudao.module.infra.controller.admin.contract` |

### 1.3 模块间数据依赖关系

```
system_users（系统用户表，已有）
      │
      ▼
hr_employee（花名册，在职状态过滤）
      │
      ├──► hr_attendance_schedule（月度排班，按在职员工生成）
      │          │
      │          ▼
      │    hr_attendance_record（打卡记录）
      │          │
      │          ▼（全勤判断）
      │
      ├──► hr_employee_salary（薪资档案：基本/岗位/补贴）
      │          │
infra_contract（合同提成数据）──►  hr_salary_monthly（月度薪资快照）
      │                                    ▲
      └──► 绩效（手动录入到 hr_salary_monthly.performance）
```

**核心结论**：花名册是所有 HR 数据的「人员入口」，考勤和合同分别为薪资提供「全勤」和「提成」数据，月度薪资是最终的汇总快照。

---

## 二、为什么要这样设计表结构

### 2.1 考勤为什么需要 4 张表

| 表 | 职责 |
|----|------|
| `hr_attendance_rule` | 定义班次制度，一条记录 = 一种班次（如早班 08:00-17:00、晚班 13:00-22:00），可配置多条 |
| `hr_holiday` | 维护每年的法定节假日和调班日（需每年导入） |
| `hr_attendance_schedule` | 按「人 × 日期」展开的月度排班，记录每人每天的班次，由系统按员工默认班次批量生成，可逐日手动调整 |
| `hr_attendance_record` | 员工实际打卡产生的记录，与排班对应，系统据此判断正常/迟到/缺勤 |

如果只有一张表，无法区分「今天本来就不用上班」和「今天该上班但没打卡」，排班规则和打卡记录必须分开。同一天不同员工可能上不同班次（早班/晚班），排班表的 `rule_id` 字段记录当天具体用哪条班次规则，从而支持混排。

### 2.2 薪资为什么需要 3 张表

| 表 | 职责 |
|----|------|
| `hr_salary_config` | 公司级别的薪资计算规则（哪些项目启用，全勤奖金额，提成如何取数） |
| `hr_employee_salary` | 每人的固定薪资档案（基本工资、岗位工资、补贴，可调整，历史版本靠 effective_date 追溯） |
| `hr_salary_monthly` | 每月结算后的快照（含当月绩效、提成、全勤的最终数值），一旦确认不可改 |

薪资配置和个人档案分开，是因为公司规则变了不应影响历史薪资快照；个人档案和月度快照分开，是因为薪资档案可以随时调整，而发出去的工资单必须是历史定格。

### 2.3 花名册为什么单独建表

`system_users` 是系统账号表，关注「能不能登录」；`hr_employee` 是 HR 视角的人员档案，关注「这个人的雇佣关系」。两者是 1:1 关系但职责不同：

- 员工离职后 `system_users` 可被禁用甚至删除，但 `hr_employee` 的离职记录要永久保留（劳动法要求留档）
- `hr_employee` 还存储 `system_users` 不关心的字段：入/离职日期、雇佣类型、身份证号、紧急联系人等

---

## 三、表结构设计（完整 SQL）

### 3.1 考勤模块

#### 表 1：排班规则表 `hr_attendance_rule`

```sql
CREATE TABLE `hr_attendance_rule` (
  `id`                          bigint       NOT NULL AUTO_INCREMENT COMMENT '规则ID',
  `name`                        varchar(50)  NOT NULL COMMENT '规则名称（如：早班、晚班）',
  `shift_type`                  tinyint      NOT NULL DEFAULT 2 COMMENT '班次类型（1=早班 2=晚班）',
  `work_days_per_week`          tinyint      NOT NULL DEFAULT 5 COMMENT '每周工作天数（5=周一至周五，6=含周六）',
  `work_start_time`             time         NOT NULL DEFAULT '09:00:00' COMMENT '上班时间',
  `work_end_time`               time         NOT NULL DEFAULT '18:00:00' COMMENT '下班时间',
  `late_threshold_minutes`      int          NOT NULL DEFAULT 15 COMMENT '迟到阈值（分钟，超过此值记迟到）',
  `early_leave_threshold_minutes` int        NOT NULL DEFAULT 15 COMMENT '早退阈值（分钟）',
  `is_follow_holiday`           bit(1)       NOT NULL DEFAULT b'1' COMMENT '是否遵循法定节假日（1=遵循，节假日自动休息）',
  `status`                      tinyint      NOT NULL DEFAULT 0 COMMENT '状态（0=启用 1=停用）',
  `remark`                      varchar(500) NOT NULL DEFAULT '' COMMENT '备注',
  `creator`    varchar(64)  DEFAULT '' COMMENT '创建者',
  `create_time` datetime    NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updater`    varchar(64)  DEFAULT '' COMMENT '更新者',
  `update_time` datetime    NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted`    bit(1)       NOT NULL DEFAULT b'0' COMMENT '是否删除',
  `tenant_id`  bigint       NOT NULL DEFAULT 0 COMMENT '租户编号',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='HR 排班规则表';

-- 插入默认早班规则
INSERT INTO `hr_attendance_rule` (`name`, `shift_type`, `work_days_per_week`, `work_start_time`, `work_end_time`,
  `late_threshold_minutes`, `early_leave_threshold_minutes`, `is_follow_holiday`, `status`, `tenant_id`)
VALUES ('早班', 1, 5, '08:00:00', '17:00:00', 15, 15, b'1', 0, 1);

-- 插入默认晚班规则（系统默认班次）
INSERT INTO `hr_attendance_rule` (`name`, `shift_type`, `work_days_per_week`, `work_start_time`, `work_end_time`,
  `late_threshold_minutes`, `early_leave_threshold_minutes`, `is_follow_holiday`, `status`, `tenant_id`)
VALUES ('晚班', 2, 5, '13:00:00', '22:00:00', 15, 15, b'1', 0, 1);
```

**设计说明**：
- **一条记录 = 一种班次**，早班和晚班各建一条规则，时间段分别配置（早班示例 08:00-17:00，晚班示例 13:00-22:00，可按实际调整）
- `shift_type` 仅用于标记和前端展示区分，实际计算迟到/早退以 `work_start_time`/`work_end_time` 为准
- `work_days_per_week=5` 表示周一到周五工作，`=6` 表示含周六，早晚班可以配置不同的工作天数
- `is_follow_holiday=1` 时，法定节假日（`hr_holiday.type=1`）自动排休，调班日（`type=2`）自动排工作
- 系统默认使用 `shift_type=2`（晚班）规则为员工生成排班，也可在花名册中为每位员工单独设置默认班次

---

#### 表 2：法定节假日表 `hr_holiday`

```sql
CREATE TABLE `hr_holiday` (
  `id`           bigint       NOT NULL AUTO_INCREMENT COMMENT '主键',
  `name`         varchar(50)  NOT NULL COMMENT '节假日名称（如：春节、元旦）',
  `holiday_date` date         NOT NULL COMMENT '具体日期',
  `type`         tinyint      NOT NULL DEFAULT 1 COMMENT '类型（1=休息日 2=调班工作日）',
  `year`         smallint     NOT NULL COMMENT '所属年份（用于按年批量查询）',
  `remark`       varchar(200) NOT NULL DEFAULT '' COMMENT '备注',
  `creator`    varchar(64)  DEFAULT '' COMMENT '创建者',
  `create_time` datetime    NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updater`    varchar(64)  DEFAULT '' COMMENT '更新者',
  `update_time` datetime    NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted`    bit(1)       NOT NULL DEFAULT b'0' COMMENT '是否删除',
  `tenant_id`  bigint       NOT NULL DEFAULT 0 COMMENT '租户编号',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_date` (`holiday_date`, `tenant_id`),
  KEY `idx_year` (`year`, `tenant_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='HR 法定节假日表';
```

**设计说明**：
- `type=1` 休息日：本来是工作日但因节假日调休休息（如 2026-01-01 元旦）
- `type=2` 调班工作日：本来是周末但因调班需要上班（如某年节前的周六）
- 每年初由管理员根据国务院通知录入，也可提供批量导入功能

---

#### 表 3：月度排班表 `hr_attendance_schedule`

```sql
CREATE TABLE `hr_attendance_schedule` (
  `id`              bigint   NOT NULL AUTO_INCREMENT COMMENT '主键',
  `user_id`         bigint   NOT NULL COMMENT '员工用户ID（关联 system_users.id）',
  `rule_id`         bigint   NOT NULL COMMENT '当日应用的排班规则ID（决定上下班时间和班次类型）',
  `shift_type`      tinyint  NOT NULL DEFAULT 2 COMMENT '班次类型快照（1=早班 2=晚班，冗余自 rule，便于直接展示）',
  `schedule_date`   date     NOT NULL COMMENT '排班日期',
  `year_month`      int      NOT NULL COMMENT '年月（如 202602，用于按月查询）',
  `day_type`        tinyint  NOT NULL DEFAULT 1 COMMENT '日类型（1=工作日 2=周末休息 3=节假日休息 4=调班工作日）',
  `is_need_clock`   bit(1)   NOT NULL DEFAULT b'1' COMMENT '是否需要打卡（0=不需要 1=需要）',
  `creator`    varchar(64)  DEFAULT '' COMMENT '创建者',
  `create_time` datetime    NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updater`    varchar(64)  DEFAULT '' COMMENT '更新者',
  `update_time` datetime    NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted`    bit(1)       NOT NULL DEFAULT b'0' COMMENT '是否删除',
  `tenant_id`  bigint       NOT NULL DEFAULT 0 COMMENT '租户编号',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_date` (`user_id`, `schedule_date`, `tenant_id`),
  KEY `idx_year_month` (`year_month`, `user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='HR 月度排班表';
```

**设计说明**：
- 每月初由系统定时任务（或手动触发）批量生成下一个月的排班记录，每人每天一行
- `rule_id` 决定当天用哪套班次规则（早班还是晚班），生成时取员工的 `default_rule_id`，管理员可逐日修改某员工当天的 `rule_id` 来临时调班
- `shift_type` 是 `rule.shift_type` 的冗余快照，避免查列表时关联查 rule 表，前端直接展示「早班/晚班」标签
- `day_type` 决定考勤表上该格的显示颜色和是否计入出勤
- `is_need_clock=0` 的日期即使没有打卡记录，也不计入缺勤
- `UNIQUE KEY (user_id, schedule_date)` 防止重复生成

---

#### 表 4：打卡记录表 `hr_attendance_record`

```sql
CREATE TABLE `hr_attendance_record` (
  `id`               bigint    NOT NULL AUTO_INCREMENT COMMENT '主键',
  `user_id`          bigint    NOT NULL COMMENT '员工用户ID',
  `schedule_id`      bigint    NOT NULL DEFAULT 0 COMMENT '关联排班ID（0=无对应排班的异常打卡）',
  `attendance_date`  date      NOT NULL COMMENT '考勤日期（冗余，便于按日查询）',
  `clock_in_time`    datetime  NULL COMMENT '签到时间',
  `clock_out_time`   datetime  NULL COMMENT '签退时间',
  `clock_in_ip`      varchar(50)  NOT NULL DEFAULT '' COMMENT '签到IP',
  `clock_out_ip`     varchar(50)  NOT NULL DEFAULT '' COMMENT '签退IP',
  `status`           tinyint   NOT NULL DEFAULT 0 COMMENT '考勤状态（0=正常 1=迟到 2=早退 3=缺勤 4=请假 5=加班）',
  `remark`           varchar(200) NOT NULL DEFAULT '' COMMENT '备注（如请假说明）',
  `creator`    varchar(64)  DEFAULT '' COMMENT '创建者',
  `create_time` datetime    NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updater`    varchar(64)  DEFAULT '' COMMENT '更新者',
  `update_time` datetime    NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted`    bit(1)       NOT NULL DEFAULT b'0' COMMENT '是否删除',
  `tenant_id`  bigint       NOT NULL DEFAULT 0 COMMENT '租户编号',
  PRIMARY KEY (`id`),
  KEY `idx_user_date` (`user_id`, `attendance_date`),
  KEY `idx_schedule_id` (`schedule_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='HR 打卡记录表';
```

**设计说明**：
- 打卡分两次：`clock_in_time`（签到）和 `clock_out_time`（签退），同一天复用同一行，签到时插入记录，签退时更新该行
- `status` 由系统在**次日凌晨定时任务**中根据排班规则自动计算并写入（不在打卡时实时计算，避免跨天问题）
- `schedule_id` 关联排班，方便考勤汇总时聚合

---

### 3.2 薪资结算模块

#### 表 5：薪资项目配置表 `hr_salary_config`

```sql
CREATE TABLE `hr_salary_config` (
  `id`                      bigint         NOT NULL AUTO_INCREMENT COMMENT '主键',
  `enable_base_salary`      bit(1)         NOT NULL DEFAULT b'1' COMMENT '是否启用基本工资',
  `enable_position_salary`  bit(1)         NOT NULL DEFAULT b'1' COMMENT '是否启用岗位工资',
  `enable_performance`      bit(1)         NOT NULL DEFAULT b'1' COMMENT '是否启用绩效',
  `enable_commission`       bit(1)         NOT NULL DEFAULT b'1' COMMENT '是否启用提成',
  `enable_allowance`        bit(1)         NOT NULL DEFAULT b'1' COMMENT '是否启用补贴',
  `enable_full_attendance`  bit(1)         NOT NULL DEFAULT b'1' COMMENT '是否启用全勤奖',
  `full_attendance_amount`  decimal(10,2)  NOT NULL DEFAULT 0.00 COMMENT '全勤奖金额（元）',
  `commission_source`       tinyint        NOT NULL DEFAULT 1 COMMENT '提成来源（1=合同管理 2=手动录入）',
  `performance_source`      tinyint        NOT NULL DEFAULT 2 COMMENT '绩效来源（1=绩效审核表 2=手动录入）',
  `remark`                  varchar(500)   NOT NULL DEFAULT '' COMMENT '备注',
  `creator`    varchar(64)  DEFAULT '' COMMENT '创建者',
  `create_time` datetime    NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updater`    varchar(64)  DEFAULT '' COMMENT '更新者',
  `update_time` datetime    NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted`    bit(1)       NOT NULL DEFAULT b'0' COMMENT '是否删除',
  `tenant_id`  bigint       NOT NULL DEFAULT 0 COMMENT '租户编号',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='HR 薪资项目配置表';

-- 初始化一条默认配置
INSERT INTO `hr_salary_config` (`enable_base_salary`, `enable_position_salary`, `enable_performance`,
  `enable_commission`, `enable_allowance`, `enable_full_attendance`, `full_attendance_amount`,
  `commission_source`, `performance_source`, `tenant_id`)
VALUES (b'1', b'1', b'1', b'1', b'1', b'1', 200.00, 1, 2, 1);
```

**设计说明**：
- 整张表只维护**一条记录**（公司级别的全局配置），前端做成「配置」页面而非列表
- `commission_source=1` 时，月结算时从 `infra_contract` 中统计该员工当月作为负责人且已生效的合同的 `commission_amount` 求和
- `performance_source=1` 时，从绩效审核表取分（暂未实现，默认为 2 手动录入）

---

#### 表 6：员工薪资档案表 `hr_employee_salary`

```sql
CREATE TABLE `hr_employee_salary` (
  `id`               bigint         NOT NULL AUTO_INCREMENT COMMENT '主键',
  `user_id`          bigint         NOT NULL COMMENT '员工用户ID（唯一）',
  `base_salary`      decimal(10,2)  NOT NULL DEFAULT 0.00 COMMENT '基本工资（元）',
  `position_salary`  decimal(10,2)  NOT NULL DEFAULT 0.00 COMMENT '岗位工资（元）',
  `allowance`        decimal(10,2)  NOT NULL DEFAULT 0.00 COMMENT '补贴（元）',
  `effective_date`   date           NOT NULL COMMENT '生效日期（用于薪资调整追溯）',
  `remark`           varchar(500)   NOT NULL DEFAULT '' COMMENT '备注（如调薪原因）',
  `creator`    varchar(64)  DEFAULT '' COMMENT '创建者',
  `create_time` datetime    NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updater`    varchar(64)  DEFAULT '' COMMENT '更新者',
  `update_time` datetime    NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted`    bit(1)       NOT NULL DEFAULT b'0' COMMENT '是否删除',
  `tenant_id`  bigint       NOT NULL DEFAULT 0 COMMENT '租户编号',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`, `tenant_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='HR 员工薪资档案表';
```

**设计说明**：
- 一个员工对应**一条当前有效档案**，调薪时更新该行（不采用多版本，避免复杂性）
- `effective_date` 记录本次档案的生效日期，月结算时取 `effective_date <= 当月最后一天` 的最新一条作为快照
- 绩效和提成不在此表，因为每月都不同，在 `hr_salary_monthly` 中按月录入

---

#### 表 7：月度薪资明细表 `hr_salary_monthly`

```sql
CREATE TABLE `hr_salary_monthly` (
  `id`                    bigint         NOT NULL AUTO_INCREMENT COMMENT '主键',
  `user_id`               bigint         NOT NULL COMMENT '员工用户ID',
  `year_month`            int            NOT NULL COMMENT '年月（如 202602）',
  `base_salary`           decimal(10,2)  NOT NULL DEFAULT 0.00 COMMENT '基本工资快照',
  `position_salary`       decimal(10,2)  NOT NULL DEFAULT 0.00 COMMENT '岗位工资快照',
  `performance`           decimal(10,2)  NOT NULL DEFAULT 0.00 COMMENT '绩效（手动录入或绩效表取数）',
  `commission`            decimal(10,2)  NOT NULL DEFAULT 0.00 COMMENT '提成（从合同管理取数或手动录入）',
  `allowance`             decimal(10,2)  NOT NULL DEFAULT 0.00 COMMENT '补贴快照',
  `full_attendance_bonus` decimal(10,2)  NOT NULL DEFAULT 0.00 COMMENT '全勤奖（满勤则取配置金额，否则为0）',
  `total_salary`          decimal(10,2)  NOT NULL DEFAULT 0.00 COMMENT '应发工资合计（以上各项之和）',
  `should_attend_days`    int            NOT NULL DEFAULT 0 COMMENT '应出勤天数（排班中工作日数量）',
  `actual_attend_days`    int            NOT NULL DEFAULT 0 COMMENT '实际出勤天数',
  `late_count`            int            NOT NULL DEFAULT 0 COMMENT '迟到次数',
  `absent_count`          int            NOT NULL DEFAULT 0 COMMENT '缺勤天数',
  `status`                tinyint        NOT NULL DEFAULT 0 COMMENT '状态（0=待确认 1=已确认 2=已发放）',
  `remark`                varchar(500)   NOT NULL DEFAULT '' COMMENT '备注',
  `creator`    varchar(64)  DEFAULT '' COMMENT '创建者',
  `create_time` datetime    NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updater`    varchar(64)  DEFAULT '' COMMENT '更新者',
  `update_time` datetime    NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted`    bit(1)       NOT NULL DEFAULT b'0' COMMENT '是否删除',
  `tenant_id`  bigint       NOT NULL DEFAULT 0 COMMENT '租户编号',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_month` (`user_id`, `year_month`, `tenant_id`),
  KEY `idx_year_month` (`year_month`, `tenant_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='HR 月度薪资明细表';
```

**设计说明**：
- `UNIQUE KEY (user_id, year_month)` 保证每人每月只有一条记录
- 所有薪资字段均为**快照**，一旦 `status=2`（已发放）则不允许修改
- `total_salary` = `base_salary` + `position_salary` + `performance` + `commission` + `allowance` + `full_attendance_bonus`，由后端计算写入，前端展示
- 月结流程：每月末由有权限的管理员触发「发起月结算」操作，系统自动拉取考勤数据、合同提成数据，生成草稿，管理员确认后状态变为「已确认」

---

### 3.3 花名册模块

#### 表 8：员工花名册表 `hr_employee`

```sql
CREATE TABLE `hr_employee` (
  `id`                  bigint       NOT NULL AUTO_INCREMENT COMMENT '主键',
  `user_id`             bigint       NOT NULL DEFAULT 0 COMMENT '关联系统用户ID（用户被删除后置0，记录保留）',
  `nickname`            varchar(30)  NOT NULL DEFAULT '' COMMENT '姓名（快照，用户被删后不丢失）',
  `dept_id`             bigint       NOT NULL DEFAULT 0 COMMENT '部门ID（快照）',
  `dept_name`           varchar(50)  NOT NULL DEFAULT '' COMMENT '部门名称（快照）',
  `post_id`             bigint       NOT NULL DEFAULT 0 COMMENT '岗位ID',
  `post_name`           varchar(50)  NOT NULL DEFAULT '' COMMENT '岗位名称（快照）',
  `mobile`              varchar(11)  NOT NULL DEFAULT '' COMMENT '手机号',
  `email`               varchar(50)  NOT NULL DEFAULT '' COMMENT '邮箱',
  `sex`                 tinyint      NOT NULL DEFAULT 0 COMMENT '性别（0=未知 1=男 2=女）',
  `avatar`              varchar(500) NOT NULL DEFAULT '' COMMENT '头像URL',
  `employment_type`     tinyint      NOT NULL DEFAULT 1 COMMENT '雇佣类型（1=全职 2=实习 3=兼职）',
  `employment_status`   tinyint      NOT NULL DEFAULT 1 COMMENT '在职状态（1=在职 2=离职 3=待入职）',
  `default_rule_id`     bigint       NOT NULL DEFAULT 0 COMMENT '默认排班规则ID（关联 hr_attendance_rule.id，0=使用系统默认晚班）',
  `join_date`           date         NULL COMMENT '入职日期',
  `formal_date`         date         NULL COMMENT '转正日期',
  `leave_date`          date         NULL COMMENT '离职日期',
  `id_card`             varchar(18)  NOT NULL DEFAULT '' COMMENT '身份证号（敏感字段，权限控制）',
  `emergency_contact`   varchar(20)  NOT NULL DEFAULT '' COMMENT '紧急联系人姓名',
  `emergency_phone`     varchar(11)  NOT NULL DEFAULT '' COMMENT '紧急联系电话',
  `remark`              varchar(500) NOT NULL DEFAULT '' COMMENT '备注',
  `creator`    varchar(64)  DEFAULT '' COMMENT '创建者',
  `create_time` datetime    NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updater`    varchar(64)  DEFAULT '' COMMENT '更新者',
  `update_time` datetime    NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted`    bit(1)       NOT NULL DEFAULT b'0' COMMENT '是否删除',
  `tenant_id`  bigint       NOT NULL DEFAULT 0 COMMENT '租户编号',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`, `tenant_id`),
  KEY `idx_dept_id` (`dept_id`),
  KEY `idx_employment_status` (`employment_status`, `tenant_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='HR 员工花名册表';
```

**设计说明**：
- `user_id` 软关联 `system_users.id`，用户被删除后 `user_id` 置 0，`nickname` 等快照字段保留，满足留档要求
- `employment_status=1`（在职）的员工才参与考勤排班和薪资结算
- `default_rule_id` 指定该员工默认走哪套班次规则（早班 or 晚班），`=0` 时系统自动取 `shift_type=2`（晚班）的启用规则，HR 可在花名册编辑页为每位员工单独切换
- `id_card` 是敏感字段，Controller 层根据权限标识 `system:hr-employee:sensitive` 决定是否脱敏返回
- 花名册数据的来源：新员工加入系统时，由 HR 手动创建，或由「用户管理」创建用户时触发自动创建（需后端改造）

---

### 3.4 在线文档模块

#### 表 9：文档分类表 `infra_doc_category`

```sql
CREATE TABLE `infra_doc_category` (
  `id`        bigint       NOT NULL AUTO_INCREMENT COMMENT '主键',
  `name`      varchar(50)  NOT NULL COMMENT '分类名称',
  `parent_id` bigint       NOT NULL DEFAULT 0 COMMENT '父分类ID（0=根分类）',
  `sort`      int          NOT NULL DEFAULT 0 COMMENT '排序',
  `status`    tinyint      NOT NULL DEFAULT 0 COMMENT '状态（0=启用 1=停用）',
  `creator`    varchar(64)  DEFAULT '' COMMENT '创建者',
  `create_time` datetime    NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updater`    varchar(64)  DEFAULT '' COMMENT '更新者',
  `update_time` datetime    NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted`    bit(1)       NOT NULL DEFAULT b'0' COMMENT '是否删除',
  `tenant_id`  bigint       NOT NULL DEFAULT 0 COMMENT '租户编号',
  PRIMARY KEY (`id`),
  KEY `idx_parent_id` (`parent_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='在线文档分类表';
```

---

#### 表 10：在线文档表 `infra_doc`

```sql
CREATE TABLE `infra_doc` (
  `id`           bigint       NOT NULL AUTO_INCREMENT COMMENT '主键',
  `category_id`  bigint       NOT NULL DEFAULT 0 COMMENT '所属分类ID',
  `name`         varchar(100) NOT NULL COMMENT '文档名称',
  `type`         tinyint      NOT NULL DEFAULT 1 COMMENT '文档类型（1=上传文件预览 2=外部链接 3=下载附件）',
  `file_url`     varchar(500) NOT NULL DEFAULT '' COMMENT '文件URL（type=1/3 时有效，通过 infra/file/upload 上传）',
  `file_type`    varchar(20)  NOT NULL DEFAULT '' COMMENT '文件扩展名（docx/xlsx/pdf 等，用于前端选择预览方案）',
  `external_url` varchar(500) NOT NULL DEFAULT '' COMMENT '外部链接（type=2 时有效）',
  `file_size`    bigint       NOT NULL DEFAULT 0 COMMENT '文件大小（字节）',
  `sort`         int          NOT NULL DEFAULT 0 COMMENT '排序',
  `status`       tinyint      NOT NULL DEFAULT 0 COMMENT '状态（0=公开 1=仅内部）',
  `view_count`   int          NOT NULL DEFAULT 0 COMMENT '浏览次数',
  `remark`       varchar(500) NOT NULL DEFAULT '' COMMENT '简介说明',
  `creator`    varchar(64)  DEFAULT '' COMMENT '创建者',
  `create_time` datetime    NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updater`    varchar(64)  DEFAULT '' COMMENT '更新者',
  `update_time` datetime    NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted`    bit(1)       NOT NULL DEFAULT b'0' COMMENT '是否删除',
  `tenant_id`  bigint       NOT NULL DEFAULT 0 COMMENT '租户编号',
  PRIMARY KEY (`id`),
  KEY `idx_category_id` (`category_id`, `tenant_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='在线文档表';
```

**设计说明**：
- `type=1` 上传文件预览：前端根据 `file_type` 判断使用何种预览组件
  - `docx/doc` → 使用 [vue-office/docx](https://github.com/501351981/vue-office) 内嵌渲染
  - `xlsx/xls` → 使用 [vue-office/excel](https://github.com/501351981/vue-office) 内嵌渲染
  - `pdf` → 使用浏览器原生 iframe 嵌入
- `type=2` 外部链接：直接 `window.open(external_url)`
- `type=3` 下载附件：前端展示文件名和大小，提供下载按钮，调用现有 `infra/file` 接口
- 文件上传复用现有 `POST /admin-api/infra/file/upload` 接口，返回 URL 后写入 `file_url`

---

### 3.5 合同管理模块

#### 表 11：合同表 `infra_contract`

```sql
CREATE TABLE `infra_contract` (
  `id`                   bigint         NOT NULL AUTO_INCREMENT COMMENT '主键',
  `contract_no`          varchar(50)    NOT NULL DEFAULT '' COMMENT '合同编号（可自动生成或手动输入）',
  `contract_name`        varchar(100)   NOT NULL COMMENT '合同名称',
  `type`                 tinyint        NOT NULL DEFAULT 1 COMMENT '合同类型（1=销售合同 2=采购合同 3=劳动合同 4=其他）',
  `customer_name`        varchar(100)   NOT NULL DEFAULT '' COMMENT '客户/供应商/乙方名称',
  `amount`               decimal(15,2)  NOT NULL DEFAULT 0.00 COMMENT '合同金额（元）',
  `sign_date`            date           NULL COMMENT '签订日期',
  `start_date`           date           NULL COMMENT '合同开始日期',
  `end_date`             date           NULL COMMENT '合同结束日期',
  `responsible_user_id`  bigint         NOT NULL DEFAULT 0 COMMENT '负责人用户ID（关联 system_users.id）',
  `responsible_username` varchar(30)    NOT NULL DEFAULT '' COMMENT '负责人姓名（快照）',
  `file_url`             varchar(500)   NOT NULL DEFAULT '' COMMENT '合同附件URL（通过 infra/file/upload 上传）',
  `commission_rate`      decimal(5,4)   NOT NULL DEFAULT 0.0000 COMMENT '提成比例（如 0.0500 = 5%）',
  `commission_amount`    decimal(10,2)  NOT NULL DEFAULT 0.00 COMMENT '提成金额（元，= amount * commission_rate，由后端自动计算）',
  `commission_year_month` int           NOT NULL DEFAULT 0 COMMENT '提成归属年月（0=按签订日期归属，非0=手动指定，如 202602）',
  `status`               tinyint        NOT NULL DEFAULT 0 COMMENT '合同状态（0=草稿 1=生效 2=已完成 3=已终止）',
  `remark`               varchar(500)   NOT NULL DEFAULT '' COMMENT '备注',
  `creator`    varchar(64)  DEFAULT '' COMMENT '创建者',
  `create_time` datetime    NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updater`    varchar(64)  DEFAULT '' COMMENT '更新者',
  `update_time` datetime    NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted`    bit(1)       NOT NULL DEFAULT b'0' COMMENT '是否删除',
  `tenant_id`  bigint       NOT NULL DEFAULT 0 COMMENT '租户编号',
  PRIMARY KEY (`id`),
  KEY `idx_responsible_user` (`responsible_user_id`, `tenant_id`),
  KEY `idx_status` (`status`, `tenant_id`),
  KEY `idx_commission_month` (`commission_year_month`, `responsible_user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='合同管理表';
```

**设计说明**：
- `commission_amount` 由后端在保存时自动计算：`amount × commission_rate`，前端只填比例即可
- `commission_year_month` 决定这笔提成算在哪个月的工资里，默认按 `sign_date` 所在月份，也可手动指定（应对跨月结算场景）
- 薪资月结算时，查询条件为：`responsible_user_id = 员工ID AND status = 1（生效）AND commission_year_month = 当月`
- 合同附件上传同样复用 `infra/file/upload`

---

## 四、核心业务逻辑

### 4.1 考勤排班生成算法

**触发时机**：每月25日定时任务自动生成次月排班；也可手动触发「生成排班」。

**算法步骤**：

```
① 查询所有 employment_status=1（在职）的员工（from hr_employee），同时取出其 default_rule_id
② 读取所有启用的排班规则（hr_attendance_rule.status=0），按 shift_type 分组备用
③ 为每位员工确定本月使用的班次规则：
    - 若 hr_employee.default_rule_id != 0 → 直接取该 rule_id 对应的规则
    - 若 default_rule_id = 0 → 取 shift_type=2（晚班）且 status=0 的第一条规则作为默认
④ 读取目标月份的节假日数据（hr_holiday.year=目标年）
⑤ 遍历目标月份的每一天，对每个员工，结合其班次规则生成一条排班记录：
    - 该日是 hr_holiday.type=1 的休假日 → day_type=3（节假日休息），is_need_clock=0
    - 该日是 hr_holiday.type=2 的调班日 → day_type=4（调班工作日），is_need_clock=1
    - 该日是周六/周日且规则 work_days_per_week=5 → day_type=2（周末休息），is_need_clock=0
    - 其余 → day_type=1（正常工作日），is_need_clock=1
    - 将员工班次规则的 rule_id 和 shift_type 写入排班记录
⑥ 批量 INSERT IGNORE（利用 UNIQUE KEY 防止重复生成）
```

**调班操作**（管理员手动改某员工某天班次）：

```
更新 hr_attendance_schedule
SET rule_id = 目标规则ID, shift_type = 目标规则的 shift_type
WHERE user_id = ? AND schedule_date = ?
```

调班后，该员工当天的迟到/早退判断自动使用新规则的上下班时间，无需其他改动。

### 4.2 打卡状态判断（次日定时任务）

每天凌晨0:10执行，处理前一天的考勤状态：

```
① 查询昨日所有 is_need_clock=1 的排班记录，JOIN hr_attendance_rule 取当日规则的
   work_start_time、work_end_time、late_threshold_minutes、early_leave_threshold_minutes
   （不同员工当天 rule_id 可能不同，早班和晚班上下班时间不同，必须关联查当日规则）
② 对每条排班记录：
    - 查找对应的打卡记录（user_id + attendance_date）
    - 无打卡记录 → status=3（缺勤）
    - 有签到，无签退 → status=2（早退/未签退，保守处理）
    - 签到时间 > 当日规则 work_start_time + late_threshold_minutes → status=1（迟到）
    - 签退时间 < 当日规则 work_end_time - early_leave_threshold_minutes → status=2（早退）
    - 其余 → status=0（正常）
③ 更新或插入 hr_attendance_record
```

### 4.3 打卡接口设计（供首页/个人中心调用）

```
POST /admin-api/system/attendance-record/clock-in   签到
POST /admin-api/system/attendance-record/clock-out  签退

签到逻辑：
① 查询今日是否有 is_need_clock=1 的排班记录，无则提示「今日无需打卡」
② 查询今日是否已有打卡记录，有且 clock_in_time 不为空则提示「已签到」
③ 无记录则新建，有记录但 clock_in 为空则更新，记录 IP
④ 不在此时计算考勤状态，留给次日定时任务
```

### 4.4 薪资月结算流程

**手动触发**：有 `system:salary:update` 权限的用户点击「发起结算」，传入年月参数。

```
① 查询当月所有 employment_status=1（在职）员工
② 对每个员工：
    a. 读取薪资档案（hr_employee_salary，取 effective_date 最近一条）
    b. 统计考勤：从 hr_attendance_schedule + hr_attendance_record 算出
       - should_attend_days = 当月 is_need_clock=1 的排班数
       - actual_attend_days = status IN (0,1) 的打卡记录数（迟到算出勤）
       - late_count = status=1 的记录数
       - absent_count = status=3 的记录数
       - 全勤判断：absent_count=0 AND late_count=0 → full_attendance_bonus = 配置金额，否则 0
    c. 从合同管理取提成：
       commission = SUM(commission_amount) WHERE responsible_user_id=员工 AND commission_year_month=当月 AND status=1
    d. 绩效（commission_source=2 手动录入）：系统生成草稿时 performance=0，管理员手动填写
    e. 计算 total_salary = 各项之和
    f. INSERT INTO hr_salary_monthly（状态=待确认）
③ 管理员逐条或批量确认 → status=1
④ 确认后标记为「已发放」→ status=2，不可修改
```

### 4.5 花名册与用户管理的联动

**新增用户时自动创建花名册记录**：

在 `AdminUserServiceImpl.createUser()` 方法末尾，调用 `HrEmployeeService.createFromUser(userId, userSaveReqVO)` 自动创建花名册记录，`employment_status` 默认为 3（待入职），HR 后续补充入职日期后改为 1（在职）。

**用户禁用/删除时**：不自动修改花名册，由 HR 在花名册中手动办理离职，填写离职日期，改 `employment_status=2`。

---

## 五、权限设计

### 5.1 权限标识一览

| 模块 | 操作 | 权限标识 |
|------|------|----------|
| 排班规则 | 查看 | `system:attendance-rule:query` |
| 排班规则 | 新增/编辑 | `system:attendance-rule:update` |
| 法定节假日 | 查看 | `system:holiday:query` |
| 法定节假日 | 新增/编辑/导入 | `system:holiday:update` |
| 考勤排班 | 查看（全员） | `system:attendance-schedule:query` |
| 考勤排班 | 手动调整 | `system:attendance-schedule:update` |
| 考勤排班 | 导出 | `system:attendance-schedule:export` |
| 打卡 | 本人打卡 | `system:attendance-record:clock`（所有员工） |
| 薪资配置 | 查看 | `system:salary-config:query` |
| 薪资配置 | 编辑 | `system:salary-config:update` |
| 薪资档案 | 查看（全员） | `system:employee-salary:query` |
| 薪资档案 | 编辑 | `system:employee-salary:update` |
| 月度薪资 | 查看（全员） | `system:salary-monthly:query` |
| 月度薪资 | 发起/确认结算 | `system:salary-monthly:update` |
| 月度薪资 | 导出 | `system:salary-monthly:export` |
| 花名册 | 查看 | `system:hr-employee:query` |
| 花名册 | 编辑（含敏感字段） | `system:hr-employee:update` |
| 花名册 | 查看身份证等敏感字段 | `system:hr-employee:sensitive` |
| 花名册 | 导出 | `system:hr-employee:export` |
| 在线文档 | 查看 | `infra:doc:query` |
| 在线文档 | 管理（上传/编辑/删除） | `infra:doc:update` |
| 合同管理 | 查看 | `infra:contract:query` |
| 合同管理 | 编辑 | `infra:contract:update` |
| 合同管理 | 导出 | `infra:contract:export` |

### 5.2 Controller 权限注解示例

```java
// 考勤排班 — 查看
@GetMapping("/page")
@PreAuthorize("@ss.hasPermission('system:attendance-schedule:query')")
public CommonResult<PageResult<AttendanceScheduleRespVO>> getPage(...) { }

// 打卡 — 所有已登录员工可用
@PostMapping("/clock-in")
@PreAuthorize("@ss.hasPermission('system:attendance-record:clock')")
public CommonResult<Boolean> clockIn(...) { }

// 月度薪资 — 发起结算（仅财务/HR）
@PostMapping("/generate")
@PreAuthorize("@ss.hasPermission('system:salary-monthly:update')")
public CommonResult<Boolean> generateMonthly(...) { }

// 花名册 — 查看，但身份证脱敏
@GetMapping("/{id}")
@PreAuthorize("@ss.hasPermission('system:hr-employee:query')")
public CommonResult<HrEmployeeRespVO> get(@PathVariable Long id) {
    HrEmployeeRespVO vo = hrEmployeeService.get(id);
    // 无敏感字段权限则脱敏
    if (!SecurityFrameworkUtils.hasPermission("system:hr-employee:sensitive")) {
        vo.setIdCard(DesensitizedUtil.idCardNum(vo.getIdCard(), 4, 4));
    }
    return success(vo);
}
```

### 5.3 数据权限（考勤/薪资查看范围）

若依内置的数据权限注解 `@DataPermission` 可按部门过滤，对于考勤和薪资的「查看本部门」场景：

- 超级管理员/HR角色：可查看全员数据
- 部门负责人角色：配置数据权限为「本部门」，只能查看自己部门员工的考勤和薪资

在 `AttendanceScheduleMapper` 和 `SalaryMonthlyMapper` 的列表查询方法上加 `@DataPermission`，框架自动注入 `dept_id IN (...)` 条件。

---

## 六、个人中心聚合面板

### 6.1 设计思路

**不新建表**，全部复用业务表，在各模块 Controller 中新增「我的视角」接口，数据层强制过滤 `user_id = 当前登录用户 ID`，员工只能看自己的数据，不受角色权限控制。

### 6.2 个人中心新增接口

| 方法 | 接口路径 | 说明 |
|------|----------|------|
| GET | `/admin-api/system/attendance-schedule/my-monthly-summary` | 本月考勤汇总（应出勤/实出勤/迟到/缺勤） |
| GET | `/admin-api/system/attendance-record/my-monthly` | 本月每日打卡状态列表（日历热力图数据源） |
| GET | `/admin-api/system/salary-monthly/my-latest` | 最近一条薪资单明细 |
| GET | `/admin-api/system/salary-monthly/my-list` | 本人历史薪资单列表 |
| GET | `/admin-api/infra/contract/my-list` | 我负责的合同列表 |
| GET | `/admin-api/system/hr-employee/my-profile` | 我的员工档案（个人可见，含完整敏感字段） |

### 6.3 接口实现要点

```java
// 以「本月考勤汇总」为例
@GetMapping("/my-monthly-summary")
@PermitAll  // 所有已登录用户可访问
public CommonResult<AttendanceMonthlySummaryVO> getMyMonthlySummary() {
    Long userId = getLoginUserId();  // 框架方法，获取当前用户ID
    Integer yearMonth = Integer.parseInt(LocalDate.now().format(DateTimeFormatter.ofPattern("yyyyMM")));
    return success(attendanceScheduleService.getMonthlySummary(userId, yearMonth));
}

// Service 层
public AttendanceMonthlySummaryVO getMonthlySummary(Long userId, Integer yearMonth) {
    // 应出勤天数
    int shouldAttend = scheduleMapper.countByUserAndMonth(userId, yearMonth, true);
    // 从打卡记录统计
    int actualAttend = recordMapper.countByStatusIn(userId, yearMonth, List.of(0, 1));
    int lateCount    = recordMapper.countByStatus(userId, yearMonth, 1);
    int absentCount  = recordMapper.countByStatus(userId, yearMonth, 3);
    // 每日状态列表（供前端日历渲染）
    List<DailyStatusVO> dailyList = recordMapper.listDailyStatus(userId, yearMonth);
    return new AttendanceMonthlySummaryVO(shouldAttend, actualAttend, lateCount, absentCount, dailyList);
}
```

### 6.4 前端个人中心改造要点

在 `src/views/system/user/profile/index.vue`（若依个人中心页面）中，新增「工作台」Tab 页，包含以下卡片：

| 卡片 | 数据来源接口 | 展示内容 |
|------|-------------|----------|
| 本月考勤 | `my-monthly-summary` + `my-monthly` | 数字统计 + 月历（绿=正常，黄=迟到，红=缺勤，灰=休息） |
| 最新薪资单 | `my-latest` | 表格展示各分项，底部显示合计 |
| 我的合同 | `my-list`（合同） | 列表，含合同名称/金额/状态/到期时间 |
| 员工档案 | `my-profile` | 入职日期、转正日期、雇佣类型等 |

---

## 七、开发步骤（完整顺序）

### 步骤总览

| 步 | 内容 | 备注 |
|----|------|------|
| 1 | 建 11 张表 | 按顺序执行 SQL |
| 2 | 代码生成（11 张表逐一生成） | 共 11 个 zip |
| 3 | 解压放入项目 | 按后端模块放置 |
| 4 | 后端改造 | 排班生成、打卡、月结算等核心逻辑 |
| 5 | 新增个人中心接口 | 各模块加「my-」前缀接口 |
| 6 | 前端改造 | 考勤日历视图、薪资明细页、花名册、文档预览、个人中心面板 |
| 7 | 建菜单 | 代码就绪后在系统管理配置 |

---

### 步骤 1：建表

**执行顺序**（按依赖关系）：

```
1. hr_attendance_rule
2. hr_holiday
3. hr_employee
4. hr_attendance_schedule
5. hr_attendance_record
6. hr_salary_config
7. hr_employee_salary
8. hr_salary_monthly
9. infra_doc_category
10. infra_doc
11. infra_contract
```

---

### 步骤 2：代码生成（逐表配置）

进入 **基础设施 → 代码生成**，导入表后逐一配置：

| 表名 | 模块名 | 业务名 | 包路径 | 模板类型 |
|------|--------|--------|--------|----------|
| `hr_attendance_rule` | `system` | `attendanceRule` | `admin.hr.attendance` | 单表 |
| `hr_holiday` | `system` | `holiday` | `admin.hr.attendance` | 单表 |
| `hr_attendance_schedule` | `system` | `attendanceSchedule` | `admin.hr.attendance` | 单表 |
| `hr_attendance_record` | `system` | `attendanceRecord` | `admin.hr.attendance` | 单表 |
| `hr_salary_config` | `system` | `salaryConfig` | `admin.hr.salary` | 单表 |
| `hr_employee_salary` | `system` | `employeeSalary` | `admin.hr.salary` | 单表 |
| `hr_salary_monthly` | `system` | `salaryMonthly` | `admin.hr.salary` | 单表 |
| `hr_employee` | `system` | `hrEmployee` | `admin.hr.employee` | 单表 |
| `infra_doc_category` | `infra` | `docCategory` | `admin.doc` | **树表** |
| `infra_doc` | `infra` | `doc` | `admin.doc` | 单表 |
| `infra_contract` | `infra` | `contract` | `admin.contract` | 单表 |

> `infra_doc_category` 选**树表**模板，代码生成器会自动生成树形结构的查询接口和前端树组件。

每张表分别下载 zip，共 11 个。

---

### 步骤 3：解压放入项目

**system 模块后端结构**：

```
yudao-module-system/src/main/java/cn/iocoder/yudao/module/system/
├── controller/admin/hr/
│   ├── attendance/
│   │   ├── AttendanceRuleController.java
│   │   ├── HolidayController.java
│   │   ├── AttendanceScheduleController.java
│   │   ├── AttendanceRecordController.java
│   │   └── vo/...
│   ├── salary/
│   │   ├── SalaryConfigController.java
│   │   ├── EmployeeSalaryController.java
│   │   ├── SalaryMonthlyController.java
│   │   └── vo/...
│   └── employee/
│       ├── HrEmployeeController.java
│       └── vo/...
├── service/hr/
│   ├── attendance/...（各 Service 接口+实现）
│   ├── salary/...
│   └── employee/...
└── dal/
    ├── dataobject/hr/...（各 DO 实体类）
    └── mysql/hr/...（各 Mapper 接口）

yudao-module-system/src/main/resources/mapper/hr/
└── ...（各 Mapper.xml）
```

**infra 模块后端结构**：

```
yudao-module-infra/src/main/java/cn/iocoder/yudao/module/infra/
├── controller/admin/
│   ├── doc/
│   │   ├── DocCategoryController.java
│   │   ├── DocController.java
│   │   └── vo/...
│   └── contract/
│       ├── ContractController.java
│       └── vo/...
├── service/
│   ├── doc/...
│   └── contract/...
└── dal/...

yudao-module-infra/src/main/resources/mapper/
├── doc/...
└── contract/...
```

**前端结构（yudao-ui-admin-vue3）**：

```
src/
├── views/
│   ├── hr/
│   │   ├── attendance/
│   │   │   ├── rule/index.vue        ← 排班规则管理
│   │   │   ├── holiday/index.vue     ← 法定节假日管理
│   │   │   ├── schedule/index.vue    ← 考勤排班表（日历视图，需重写）
│   │   │   └── record/index.vue      ← 打卡记录查看
│   │   ├── salary/
│   │   │   ├── config/index.vue      ← 薪资配置
│   │   │   ├── employee/index.vue    ← 员工薪资档案
│   │   │   └── monthly/index.vue     ← 月度薪资明细
│   │   └── employee/
│   │       └── index.vue             ← 花名册（卡片/列表视图）
│   └── infra/
│       ├── doc/
│       │   ├── category/index.vue    ← 文档分类管理
│       │   └── list/index.vue        ← 文档列表（含预览）
│       └── contract/
│           └── index.vue             ← 合同管理
└── api/
    ├── hr/
    │   ├── attendance/               ← 各考勤接口 ts 文件
    │   ├── salary/                   ← 各薪资接口 ts 文件
    │   └── employee/                 ← 花名册接口 ts 文件
    └── infra/
        ├── doc.ts
        └── contract.ts
```

---

### 步骤 4：后端改造要点

**考勤模块改造**：

1. `AttendanceScheduleServiceImpl` 新增 `generateMonthlySchedule(Integer yearMonth)` 方法，实现第四节 4.1 的排班算法，并配置定时任务（`@Scheduled(cron = "0 0 1 25 * ?")`）
2. `AttendanceRecordController` 新增 `clockIn()` 和 `clockOut()` 接口，逻辑见第四节 4.3
3. 新增每日定时任务 `@Scheduled(cron = "0 10 0 * * ?")` 计算前一天考勤状态，见第四节 4.2
4. 考勤表列表接口支持按「年月 + 部门」聚合查询，返回二维数组（行=员工，列=日期）供前端渲染日历

**薪资模块改造**：

1. `SalaryMonthlyController` 新增 `generateMonthly(Integer yearMonth)` 接口，实现第四节 4.4 的月结算流程
2. `SalaryMonthlyController` 新增 `confirm(Long id)` 和 `batchConfirm(List<Long> ids)` 接口
3. 月结算时，从 `infra_contract` 表跨模块取提成数据，在 `yudao-module-system` 中通过 `ContractApi`（在 `yudao-module-infra` 中定义）调用，遵循若依模块间 API 调用规范

**花名册模块改造**：

1. `AdminUserServiceImpl.createUser()` 中注入 `HrEmployeeService`，创建用户后自动创建花名册记录（`employment_status=3 待入职`）
2. `HrEmployeeController` 新增 `getMyProfile()` 接口，返回当前用户自己的档案

**个人中心接口（各模块补充）**：

在对应 Controller 中新增「my-」前缀接口，所有接口使用 `@PermitAll`，Service 层硬编码 `user_id = getLoginUserId()`。

---

### 步骤 5：前端改造要点

**考勤排班表（核心改造，需重写页面）**：

代码生成的是普通列表页，需改为「月历视图」：
- 顶部：年月选择器 + 部门筛选 + 「生成排班」按钮（权限控制）
- 表格：行=员工，列=1~31日，单元格颜色：绿=正常打卡，黄=迟到，红=缺勤，灰=休息
- 点击单元格可查看/修改当日考勤状态

**在线文档预览**：

安装前端文档预览库（以 vue-office 为例）：
```bash
npm install @vue-office/docx @vue-office/excel
```

在 `doc/list/index.vue` 中根据 `file_type` 字段动态渲染：
```vue
<VueOfficeDocx v-if="doc.fileType === 'docx'" :src="doc.fileUrl" />
<VueOfficeExcel v-else-if="doc.fileType === 'xlsx'" :src="doc.fileUrl" />
<iframe v-else-if="doc.fileType === 'pdf'" :src="doc.fileUrl" />
<a v-else :href="doc.fileUrl" target="_blank">下载文件</a>
```

**首页打卡快捷入口**：

在首页组件中调用 `POST /admin-api/system/attendance-record/clock-in`，展示今日打卡状态，提供签到/签退按钮。

---

### 步骤 6：建菜单（代码就绪后）

在 **系统管理 → 菜单管理** 中配置：

**人事专栏（新增一级目录）**：

| 字段 | 值 |
|------|----|
| 菜单类型 | 目录 |
| 菜单名称 | 人事专栏 |
| 路由地址 | `hr` |
| 图标 | 自选（建议 user-group 类图标） |

**人事专栏下的子菜单**：

| 菜单名称 | 路由地址 | 组件路径 | 菜单显示权限（任选其一即可见菜单） |
|----------|----------|----------|----------------------------------|
| 考勤 | `attendance` | `hr/attendance/schedule/index` | `system:attendance-schedule:query` |
| 薪资结算 | `salary` | `hr/salary/monthly/index` | `system:salary-monthly:query` |
| 花名册 | `employee` | `hr/employee/index` | `system:hr-employee:query` |

**基础设施下新增子菜单**：

| 菜单名称 | 路由地址 | 组件路径 | 菜单显示权限 |
|----------|----------|----------|--------------|
| 在线文档 | `doc` | `infra/doc/list/index` | `infra:doc:query` |
| 合同管理 | `contract` | `infra/contract/index` | `infra:contract:query` |

**完整权限标识清单（需在「系统管理 → 角色管理」中配置后，前端按钮/接口才会生效）**：

**考勤模块**：

| 权限标识 | 说明 | 对应操作 |
|----------|------|----------|
| `system:attendance-rule:query` | 排班规则-查询 | 查看规则列表、详情、下拉选项 |
| `system:attendance-rule:update` | 排班规则-维护 | 新增、修改、删除规则 |
| `system:holiday:query` | 法定节假日-查询 | 查看节假日列表、详情 |
| `system:holiday:update` | 法定节假日-维护 | 新增、修改、删除节假日 |
| `system:attendance-schedule:query` | 考勤排班-查询 | 查看排班列表、个人本月排班、考勤汇总 |
| `system:attendance-schedule:update` | 考勤排班-维护 | 生成排班、临时调班 |
| `system:attendance-record:clock` | 打卡 | 签到、签退（所有在职员工建议分配） |

**花名册模块**：

| 权限标识 | 说明 | 对应操作 |
|----------|------|----------|
| `system:hr-employee:query` | 花名册-查询 | 查看员工列表、详情 |
| `system:hr-employee:update` | 花名册-维护 | 新增、修改、删除员工记录 |
| `system:hr-employee:sensitive` | 花名册-敏感字段 | 查看身份证号明文（无此权限则脱敏） |
| `system:hr-employee:export` | 花名册-导出 | 导出 Excel |

**薪资模块**：

| 权限标识 | 说明 | 对应操作 |
|----------|------|----------|
| `system:salary-config:query` | 薪资配置-查询 | 查看薪资公式配置 |
| `system:salary-config:update` | 薪资配置-维护 | 修改薪资公式、全勤奖等 |
| `system:employee-salary:query` | 员工薪资档案-查询 | 查看员工薪资档案列表 |
| `system:employee-salary:update` | 员工薪资档案-维护 | 新增、修改员工薪资档案 |
| `system:salary-monthly:query` | 月度薪资-查询 | 查看月度薪资列表、详情 |
| `system:salary-monthly:update` | 月度薪资-维护 | 生成月结算、编辑绩效/提成、确认薪资单 |
| `system:salary-monthly:export` | 月度薪资-导出 | 导出 Excel |

**在线文档模块**：

| 权限标识 | 说明 | 对应操作 |
|----------|------|----------|
| `infra:doc:query` | 在线文档-查询 | 查看文档列表、详情、分类树 |
| `infra:doc:update` | 在线文档-维护 | 新增、修改、删除文档及分类 |

**合同管理模块**：

| 权限标识 | 说明 | 对应操作 |
|----------|------|----------|
| `infra:contract:query` | 合同-查询 | 查看合同列表、详情 |
| `infra:contract:update` | 合同-维护 | 新增、修改、删除合同 |
| `infra:contract:export` | 合同-导出 | 导出 Excel |

**建菜单时的权限配置建议**：每个菜单可绑定多个权限，通常将「查询」权限作为菜单显示条件；具体按钮（新增、编辑、删除、导出等）在前端用 `v-hasPermi` 指令根据上表对应权限控制。

---

## 八、注意事项

### 8.1 考勤模块

- 排班生成前必须确认：①「法定节假日」已录入；②「早班」和「晚班」规则均已配置并启用，否则 `default_rule_id=0` 的员工找不到晚班规则，排班会失败
- 系统**默认所有员工走晚班**（`shift_type=2`），HR 可在花名册编辑页为每位员工修改 `default_rule_id` 切换到早班，无需逐日手动调整
- 管理员也可以在已生成的排班表中，针对某员工的某一天修改 `rule_id`（临时调班），不影响其他日期
- 定时任务生成排班和计算考勤状态，需确认 `yudao-module-system` 中的定时任务框架已启用（若依使用 Quartz 或 Spring Scheduled）
- 打卡状态判断时**必须关联当日的 rule_id 取上下班时间**，而不是取员工的默认规则，因为当天可能已经被临时调班
- 多租户环境下，排班生成时需按 `tenant_id` 隔离，每个租户独立的规则和节假日

### 8.2 薪资模块

- 月结算操作不可逆，`status=2（已发放）` 后禁止修改任何薪资字段（Controller 层校验）
- 跨模块调用合同数据时（system 模块调用 infra 模块的合同接口），需在 `yudao-module-infra` 的 API 子包中定义 `ContractApi` 接口，在 `yudao-module-system` 中引入依赖并调用，遵循若依模块间通信规范

### 8.3 花名册

- `hr_employee.id_card` 身份证号字段，即使有 `system:hr-employee:query` 权限也不应明文返回，需额外的 `system:hr-employee:sensitive` 权限才能看明文，其余情况脱敏展示（411***199001016543）
- 员工离职后，对应的 `hr_attendance_schedule` 历史记录保留，`hr_salary_monthly` 历史记录保留，新月份不再为该员工生成排班

### 8.4 在线文档

- 文档预览组件（vue-office）加载大文件时较慢，建议加 Loading 状态
- PDF 预览使用 iframe 时，若文件服务器未设置 CORS 或 `X-Frame-Options`，会显示不出来，需在文件存储配置中允许跨域

### 8.5 个人中心

- 个人中心接口使用 `@PermitAll` 而非 `@PreAuthorize("@ss.hasPermission(...)")`，前者只要求登录，无需在角色管理中配置权限
- 薪资单在个人中心只展示 `status=1 或 2`（已确认/已发放）的记录，草稿状态员工不可见

---

## 九、常见问题

| 问题 | 原因 | 处理 |
|------|------|------|
| 排班生成后某些员工没有记录 | `hr_employee.employment_status != 1` | 检查花名册在职状态 |
| 排班生成报错找不到规则 | `default_rule_id=0` 但系统中没有启用的晚班规则 | 先在排班规则中新增晚班并启用 |
| 员工考勤状态判断用了错误的上下班时间 | 打卡状态计算用了员工默认规则而非当日规则 | 检查 Service 层是否关联 `schedule.rule_id` 取时间，而非 `employee.default_rule_id` |
| 节假日仍然排了工作日 | `hr_attendance_rule.is_follow_holiday=0` 或节假日未录入 | 检查规则配置和节假日数据 |
| 打卡后考勤状态不更新 | 状态由次日定时任务计算，不实时 | 属正常逻辑，次日凌晨后刷新 |
| 月结算提成为0 | 合同 `status != 1` 或 `commission_year_month` 不匹配 | 检查合同状态和归属月份字段 |
| 文档预览空白 | 文件 URL 不可访问或 CORS 问题 | 检查文件存储主配置和跨域设置 |
| 个人中心薪资单看不到 | 当月薪资单还是草稿（status=0） | 属正常逻辑，等待管理员确认 |
| 代码生成放错模块 | zip 解压路径基准错误 | 路径基准是项目根目录，不是 src |

---

## 十、总结

| 方面 | 结论 |
|------|------|
| 表数量 | 共 11 张新建表，全部走代码生成 + 手工改造 |
| 代码生成价值 | 11 张表的 CRUD 脚手架（Controller/Service/Mapper/VO/前端列表页）全部自动生成，节省 60%～70% 重复代码 |
| 手工改造重点 | 排班批量生成算法、打卡逻辑、考勤状态定时计算、月薪结算流程、跨模块 API 调用 |
| 前端重点改造 | 考勤日历视图（行=员工，列=日期）、文档预览组件接入、个人中心工作台面板 |
| 权限体系 | 完全复用若依角色权限，用 `@PreAuthorize("@ss.hasPermission(...)")` 控制，个人视角接口用 `@PermitAll` |
| 数据安全 | 薪资和花名册敏感字段加权限控制，个人中心接口 Service 层强制 userId 过滤 |
| 开发顺序 | 建表 → 代码生成 → 放代码 → 后端改造 → 前端改造 → 建菜单 |
